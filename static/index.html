<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Trakt Multi-Scrobbler</title>
    <link rel="icon" type="image/webp" href="/static/scrobbler_icon.webp" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Space Grotesk"', 'ui-sans-serif', 'system-ui', 'sans-serif'],
                        mono: ['"JetBrains Mono"', 'ui-monospace', 'SFMono-Regular', 'monospace']
                    },
                    boxShadow: {
                        glow: '0 0 0 1px rgba(56,189,248,.28), 0 18px 38px -18px rgba(56,189,248,.45)'
                    }
                }
            }
        };
    </script>
    <style type="text/tailwindcss">
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Space+Grotesk:wght@400;500;700&display=swap');

        @layer base {
            :root {
                color-scheme: dark;
                --bg: #030712;
                --bg-soft: #0a1222;
                --panel: #0c1728;
                --panel-2: #0f1d33;
                --border: #1f3553;
                --text: #e6efff;
                --muted: #9cb0cb;
                --accent: #22d3ee;
                --pill-bg: rgba(12, 23, 40, 0.82);
                --pill-text: #dbe9ff;
                --poster-bg: #07101f;
            }

            [data-theme="light"] {
                color-scheme: light;
                --bg: #eef4ff;
                --bg-soft: #dbe8ff;
                --panel: #ffffff;
                --panel-2: #f2f7ff;
                --border: #bfd2ee;
                --text: #0f1c33;
                --muted: #516380;
                --accent: #0284c7;
                --pill-bg: rgba(244, 248, 255, 0.96);
                --pill-text: #0f1c33;
                --poster-bg: #dfeafb;
            }

            html, body {
                @apply min-h-full;
            }

            body {
                @apply m-0 font-sans text-[var(--text)] antialiased;
                background:
                    radial-gradient(900px 500px at 12% -15%, color-mix(in srgb, var(--accent) 24%, transparent), transparent 55%),
                    radial-gradient(700px 420px at 88% 0%, color-mix(in srgb, #14b8a6 18%, transparent), transparent 62%),
                    linear-gradient(180deg, var(--bg-soft), var(--bg));
            }

            button {
                @apply text-sm font-medium transition-all duration-150;
            }

            input, select {
                @apply rounded-xl border px-3 py-2 text-sm outline-none transition;
                border-color: var(--border);
                color: var(--text);
                background: color-mix(in srgb, var(--panel) 92%, transparent);
            }

            input:focus, select:focus {
                border-color: color-mix(in srgb, var(--accent) 68%, var(--border));
                box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent) 18%, transparent);
            }
        }

        @layer components {
            header {
                @apply sticky top-0 z-30 flex items-center justify-between gap-3 border-b px-4 py-4 backdrop-blur-xl;
                border-color: var(--border);
                background: color-mix(in srgb, var(--bg) 70%, transparent);
            }

            main {
                @apply mx-auto w-full max-w-7xl px-4 py-6;
            }

            .brand {
                @apply font-bold tracking-wide;
            }

            .pill {
                @apply inline-flex items-center gap-1.5 rounded-full border px-3 py-1.5 text-xs font-medium transition-all duration-150;
                border-color: var(--border);
                background: var(--pill-bg);
                color: var(--pill-text);
            }

            .pill:hover {
                @apply -translate-y-px;
                border-color: color-mix(in srgb, var(--accent) 48%, var(--border));
            }

            .pill img {
                filter: invert(1);
            }

            [data-theme="light"] .pill img {
                filter: invert(0);
            }

            .panel {
                @apply mb-5 rounded-2xl border p-4 shadow-[0_18px_40px_-28px_rgba(2,132,199,.65)];
                border-color: var(--border);
                background: linear-gradient(160deg, color-mix(in srgb, var(--panel) 97%, transparent), color-mix(in srgb, var(--panel-2) 96%, transparent));
                animation: panel-enter .24s ease-out both;
            }

            .row {
                @apply mb-3 flex w-full flex-wrap items-center gap-2.5;
            }

            .alpha-row {
                @apply mb-3 grid w-full gap-1.5;
                grid-template-columns: repeat(27, minmax(26px, 1fr));
            }

            .alpha-row button {
                @apply w-full justify-center px-0;
            }

            button.active, .pill.active {
                border-color: color-mix(in srgb, var(--accent) 78%, var(--border));
                box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent) 18%, transparent);
            }

            .grid {
                @apply grid gap-2.5;
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            }

            .card {
                @apply flex gap-3 overflow-hidden rounded-2xl border p-3 transition-all duration-150 hover:-translate-y-px hover:shadow-glow;
                border-color: var(--border);
                background: linear-gradient(145deg, color-mix(in srgb, var(--panel) 98%, transparent), color-mix(in srgb, var(--panel-2) 97%, transparent));
            }

            .poster {
                @apply flex h-[110px] w-[74px] shrink-0 items-center justify-center overflow-hidden rounded-xl;
                background: var(--poster-bg);
            }

            .poster img {
                @apply block h-full w-full object-cover;
            }

            .meta {
                @apply flex flex-col gap-1.5 py-0.5;
            }

            .title {
                @apply text-sm font-bold leading-tight text-[var(--text)];
            }

            .sub {
                @apply min-h-[18px] text-xs text-[var(--muted)];
            }

            .muted {
                @apply text-xs text-[var(--muted)];
            }

            .modal-backdrop {
                @apply fixed inset-0 z-40 hidden items-center justify-center bg-black/60 p-5 backdrop-blur-sm;
            }

            .modal-panel {
                @apply flex max-h-[90vh] w-full max-w-4xl flex-col overflow-hidden rounded-2xl border;
                border-color: var(--border);
                background: linear-gradient(160deg, color-mix(in srgb, var(--panel) 97%, transparent), color-mix(in srgb, var(--panel-2) 96%, transparent));
            }

            .modal-header {
                @apply flex items-center justify-between gap-3 border-b px-4 py-3;
                border-color: var(--border);
            }

            .modal-body {
                @apply flex min-h-[200px] flex-1 flex-col gap-2.5 overflow-y-auto p-4;
                max-height: calc(90vh - 100px);
            }
        }

        @keyframes panel-enter {
            from {
                opacity: 0;
                transform: translateY(6px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 900px) {
            .alpha-row {
                grid-template-columns: repeat(9, minmax(26px, 1fr));
            }
        }
    </style>
</head>

<body>
    <div id="bootLoading" style="position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:linear-gradient(120deg, rgba(9,13,23,.9), rgba(14,19,32,.9)); color:#e8eefc; z-index:9999; font-size:18px; gap:10px;">
        <span>‚è≥</span>
        <span id="bootLoadingText">Loading data‚Ä¶</span>
    </div>
    <header>
        <div class="brand" style="display:flex; align-items:center; gap:8px;">
            <a href="/" style="display:flex; align-items:center; gap:8px; color:inherit; text-decoration:none;">
                <img src="/static/scrobbler_icon.webp" alt="" width="44" height="44" aria-hidden="true" />
                <div>
                    <div id="brandTitle" style="font-size:18px;">Trakt Multi-Scrobbler</div>
                    <div id="brandSubtitle" class="muted" style="font-size:12px;">Jellyfin ‚Üí Trakt per pi√π utenti</div>
                </div>
            </a>
        </div>
        <div style="display:flex; gap:8px; align-items:center;">
            <button id="btnJellyfinModal" class="pill" style="cursor:pointer;">üë§ Jellyfin User(s)</button>
            <button id="btnTraktModal" class="pill" style="cursor:pointer;">üë§ Trakt User(s)</button>
            <div id="summary" class="pill">‚ÑπÔ∏è Loading‚Ä¶</div>
            <button id="btnBackup" class="pill" style="cursor:pointer;" title="Backup">üíæ Backup</button>
            <input type="file" id="backupFile" accept=".zip" style="display:none;">
            <select id="langSelect" class="pill" style="cursor:pointer; border-radius:12px;">
                <option value="en">üåê EN</option>
                <option value="it">üåê IT</option>
            </select>
            <button id="btnTheme" class="pill" style="cursor:pointer;">‚åó</button>
            <a id="btnGithub" class="pill" style="cursor:pointer; text-decoration:none; display:flex; align-items:center; gap:6px;" href="https://github.com/gioxx/trakt-multi-scrobbler" target="_blank" rel="noopener">
                <img src="/static/github.svg" alt="GitHub" width="16" height="16" aria-hidden="true" style="display:block;" />
            </a>
        </div>
    </header>

    <main>
        <div id="backendStatus" style="display:none; margin-bottom:10px; padding:10px 12px; border-radius:12px; border:1px solid #613b2f; background:#2d1a15; color:#f3d9d0; font-weight:600;">
            ‚ö†Ô∏è Jellyfin non raggiungibile. Riprova pi√π tardi o controlla JELLYFIN_URL / rete.
        </div>
        <section class="panel">
            <div style="display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap; align-items:flex-start; margin-bottom:8px;">
                <div>
                    <div id="recentTitle" style="font-weight:700; font-size:17px;">Ultimi visti</div>
                    <div id="recentHelper" class="muted">Contenuti appena visti dagli utenti Jellyfin selezionati.</div>
                </div>
            </div>
            <div id="recentList" class="grid"></div>
        </section>

        <section id="orphansSection" class="panel" style="display:none;">
            <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; margin-bottom:10px;">
                <div>
                    <div id="orphansTitle" style="font-weight:700; font-size:17px;">Unassigned content</div>
                    <div id="orphansHelper" class="muted">Nuovi titoli senza alcun account Trakt selezionato.</div>
                </div>
                <div class="pill" id="orphansCount">0</div>
            </div>
            <div id="orphansList" style="display:flex; gap:8px; flex-wrap:wrap;"></div>
        </section>

        <section class="panel">
            <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; margin-bottom:10px;">
                <div>
                    <div id="contentTitle" style="font-weight:700; font-size:17px;">Content filters</div>
                    <div id="contentHelper" class="muted">Decidi per quali account Trakt scrobbla ogni film/serie.</div>
                </div>
            </div>
            <div class="row">
                <input id="search" placeholder="Filter content‚Ä¶" style="flex:1 1 320px;" />
                <div style="display:flex; gap:6px; flex-wrap:wrap;">
                    <button id="filterAll" class="pill">All</button>
                    <button id="filterMovies" class="pill">Movies</button>
                    <button id="filterShows" class="pill">Shows</button>
                    <button id="filterUnassigned" class="pill">Unassigned</button>
                </div>
                <div style="display:flex; gap:6px; align-items:center; flex-wrap:wrap;">
                    <label class="muted" for="accountFilter" id="accountFilterLabel">Assigned to:</label>
                    <select id="accountFilter" style="min-width:180px;"></select>
                </div>
            </div>
            <div class="row" style="justify-content:space-between; gap:10px; flex-wrap:wrap;">
                <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                    <label class="muted" for="bulkAccount">Bulk target:</label>
                    <select id="bulkAccount" style="min-width:220px;"></select>
                </div>
                <div style="display:flex; gap:8px; flex-wrap:wrap;">
                    <button id="btnSelectAll">Select all</button>
                    <button id="btnDeselectAll">Deselect all</button>
                </div>
            </div>
            <div id="alphaBar" class="alpha-row"></div>
            <div id="grid" class="grid"></div>
        </section>
    </main>

    <div id="deviceModal" class="modal-backdrop" style="display:none;">
        <div class="modal-panel">
            <div class="modal-header">
                <div id="deviceTitle" style="font-weight:700;">Add Trakt account</div>
                <button id="btnCloseDevice">Close</button>
            </div>
            <div class="modal-body">
                <p id="deviceStep" class="muted"></p>
                <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                    <div id="deviceCode" style="font-size:28px; font-weight:700;">‚Äî</div>
                    <a id="deviceUrl" href="#" target="_blank" rel="noopener" style="color:#5b7cff;">Open verification URL</a>
                </div>
                <div id="deviceStatus" class="muted"></div>
                <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:10px; flex-wrap:wrap;">
                    <button id="btnPollNow">Check now</button>
                    <button id="btnCancelDevice">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <div id="jellyfinModal" class="modal-backdrop" style="display:none;">
        <div class="modal-panel">
            <div class="modal-header">
                <div id="jellyfinTitle" style="font-weight:700;">Jellyfin users</div>
                <button id="btnCloseJellyfin">Close</button>
            </div>
            <div class="modal-body">
                <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap; margin-bottom:8px;">
                    <p id="jellyfinHelper" class="muted" style="margin:0;">Scegli quali utenti Jellyfin usare come base per lo scrobbling.</p>
                    <button id="btnRefresh" class="pill" style="cursor:pointer;">‚Üª</button>
                </div>
                <div id="jellyfinUsers" class="grid"></div>
            </div>
        </div>
    </div>

    <div id="traktModal" class="modal-backdrop" style="display:none;">
        <div class="modal-panel">
            <div class="modal-header">
                <div id="traktTitle" style="font-weight:700;">Trakt accounts</div>
                <button id="btnCloseTrakt">Close</button>
            </div>
            <div class="modal-body">
                <p id="traktHelper" class="muted">Attiva o disattiva lo scrobbling per ciascun account collegato.</p>
                <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px;">
                    <button id="btnAddTrakt">Add Trakt account</button>
                    <button id="btnReloadTrakt">Reload accounts</button>
                    <button id="btnSync">‚áÖ</button>
                </div>
                <div id="traktNotice" class="muted" style="margin-bottom:10px; display:none;"></div>
                <div id="traktAccounts" class="grid"></div>
            </div>
        </div>
    </div>

    <div id="backupModal" class="modal-backdrop" style="display:none;">
        <div class="modal-panel">
            <div class="modal-header">
                <div id="backupTitle" style="font-weight:700;">Backup &amp; Restore</div>
                <button id="btnCloseBackup">Close</button>
            </div>
            <div class="modal-body">
                <p id="backupHelper" class="muted">Scarica la configurazione o ripristina da un file ZIP.</p>
                <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:10px;">
                    <button id="btnBackupDownload" class="pill">üíæ <span id="backupDownloadLabel">Backup</span></button>
                    <button id="btnBackupRestore" class="pill">üìÇ <span id="backupRestoreLabel">Restore</span></button>
                </div>
                <input type="file" id="backupFile" accept=".zip" style="display:none;">
                <div class="muted" style="font-size:12px;">
                    <span id="backupHint">Il backup include token Trakt (JSON), regole/DB SQLite e stato Jellyfin.</span>
                </div>
                <div style="margin-top:14px; padding-top:10px; border-top:1px solid var(--border);">
                    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; margin-bottom:8px;">
                        <div>
                            <div id="cacheTitle" style="font-weight:700;">Poster cache</div>
                            <div id="cacheHelper" class="muted" style="font-size:12px;">Info cache locandine e refresh forzato.</div>
                        </div>
                        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                            <button id="btnCacheRefresh" class="pill">‚Üª <span id="cacheRefreshLabel">Refresh</span></button>
                        </div>
                    </div>
                    <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; font-size:13px;">
                        <div class="pill" id="cacheLast">‚Äî</div>
                        <div class="pill" id="cacheFiles">‚Äî</div>
                        <div class="pill" id="cacheSize">‚Äî</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" style="position:fixed; right:16px; bottom:16px; padding:10px 12px; border-radius:10px; border:1px solid var(--border); box-shadow:0 4px 14px rgba(0,0,0,0.25); display:none; z-index:9999; min-width:200px; max-width:320px; background: var(--panel); color: var(--text);"></div>

    <script>
        let translations = {};
        let currentLang = 'en';
        const bootLoading = document.getElementById('bootLoading');
        const bootLoadingText = document.getElementById('bootLoadingText');
        const backendStatus = document.getElementById('backendStatus');
        let jellyfinUsers = [];
        let traktAccounts = [];
        let devicePollTimer = null;
        let currentDeviceCode = '';
        let deviceExpiresAt = 0;
        let devicePollIntervalSec = 5;
        let lastPollError = false;
        let contentItems = [];
        let contentFilter = 'all';
        let alphaFilter = '';
        let recentItems = [];
        let accountFilter = '';
        let toastTimer = null;
        let currentTheme = 'dark';

        function showStatus(message, type = 'info') {
            const el = document.getElementById('toast');
            if (!el) return;
            const icon = type === 'error' ? '‚ö†Ô∏è' : type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è';
            el.textContent = `${icon} ${message}`;
            const color = type === 'error' ? '#3b1b1b' : type === 'success' ? '#11321e' : '#132033';
            const border = type === 'error' ? '#7a2c2c' : type === 'success' ? '#235932' : '#1f2c44';
            el.style.background = color;
            el.style.borderColor = border;
            el.style.display = 'block';
            clearTimeout(toastTimer);
            toastTimer = setTimeout(() => {
                el.style.display = 'none';
            }, 2600);
        }

        function setBackendStatus(message = '', visible = false) {
            if (!backendStatus) return;
            backendStatus.textContent = message || '‚ö†Ô∏è Jellyfin non raggiungibile. Riprova o controlla JELLYFIN_URL.';
            backendStatus.style.display = visible ? 'block' : 'none';
        }

        function applyTheme(theme) {
            currentTheme = theme;
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            const btn = document.getElementById('btnTheme');
            if (btn) {
                btn.textContent = theme === 'light' ? '‚óê' : '‚óë';
                btn.setAttribute('aria-label', theme === 'light' ? t('theme.dark') : t('theme.light'));
            }
        }

        function initTheme() {
            const saved = localStorage.getItem('theme');
            if (saved === 'light' || saved === 'dark') {
                applyTheme(saved);
                return;
            }
            const prefersLight = window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches;
            applyTheme(prefersLight ? 'light' : 'dark');
        }

        function escapeHtml(s) {
            return String(s || '').replace(/[&<>"']/g, (c) => ({
                '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
            }[c]));
        }

        function t(key, vars = {}) {
            const base = translations[key] || translations[key.replace(/:[^.]*/, '')] || key;
            return Object.keys(vars).reduce((acc, k) => acc.replace(new RegExp(`{${k}}`, 'g'), vars[k]), base);
        }

        function renderAlphaBar() {
            const bar = document.getElementById('alphaBar');
            const letters = ['#'].concat('ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split(''));
            bar.innerHTML = letters.map(l => {
                const active = alphaFilter === l ? 'active' : '';
                return `<button class="pill ${active}" data-letter="${l}">${l}</button>`;
            }).join('');
            bar.querySelectorAll('button[data-letter]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const val = btn.getAttribute('data-letter');
                    alphaFilter = alphaFilter === val ? '' : val;
                    renderAlphaBar();
                    renderContentList();
                });
            });
        }

        async function loadLang(lang) {
            currentLang = lang;
            try {
                const r = await fetch(`/static/locales/${lang}.json`);
                translations = await r.json();
            } catch (e) {
                translations = {};
            }
            localStorage.setItem('lang', lang);
            applyStaticText();
        }

        function applyStaticText() {
            document.title = t('title');
            document.getElementById('brandTitle').textContent = t('title');
            document.getElementById('brandSubtitle').textContent = t('subtitle');
            document.getElementById('btnRefresh').textContent = t('button.refresh');
            document.getElementById('btnSync').textContent = t('button.sync');
            document.getElementById('btnJellyfinModal').textContent = `${t('button.jellyfinModal')} ${t('label.usersSuffix')}`;
            document.getElementById('btnTraktModal').textContent = `${t('button.traktModal')} ${t('label.usersSuffix')}`;
            document.getElementById('jellyfinTitle').textContent = t('panel.jellyfinTitle');
            document.getElementById('jellyfinHelper').textContent = t('panel.jellyfinHelper');
            document.getElementById('traktTitle').textContent = t('panel.traktTitle');
            document.getElementById('traktHelper').textContent = t('panel.traktHelper');
            document.getElementById('btnCloseJellyfin').textContent = t('modal.close');
            document.getElementById('btnAddTrakt').textContent = t('button.addAccount');
            document.getElementById('btnReloadTrakt').textContent = t('button.reloadAccounts');
            document.getElementById('btnCloseTrakt').textContent = t('modal.close');
            document.getElementById('recentTitle').textContent = t('panel.recentTitle');
            document.getElementById('recentHelper').textContent = t('panel.recentHelper');
            document.getElementById('contentTitle').textContent = t('panel.contentTitle');
            document.getElementById('contentHelper').textContent = t('content.helper');
            document.getElementById('search').placeholder = t('search.placeholder');
            document.getElementById('filterAll').textContent = t('filter.all');
            document.getElementById('filterMovies').textContent = t('filter.movies');
            document.getElementById('filterShows').textContent = t('filter.shows');
            document.getElementById('filterUnassigned').textContent = t('filter.unassigned');
            document.getElementById('accountFilterLabel').textContent = t('filter.accountLabel');
            document.getElementById('btnSelectAll').textContent = t('bulk.select');
            document.getElementById('btnDeselectAll').textContent = t('bulk.deselect');
            renderAlphaBar();
            document.getElementById('deviceTitle').textContent = t('modal.deviceTitle');
            document.getElementById('btnCloseDevice').textContent = t('modal.close');
            document.getElementById('btnCancelDevice').textContent = t('modal.cancel');
            document.getElementById('btnPollNow').textContent = t('modal.pollNow');
            document.getElementById('deviceStep').textContent = t('modal.deviceStep');
            document.getElementById('deviceUrl').textContent = t('modal.openUrl');
            document.getElementById('orphansTitle').textContent = t('orphans.title');
            document.getElementById('orphansHelper').textContent = t('orphans.helper');

            document.getElementById('langSelect').value = currentLang;
            document.querySelectorAll('#langSelect option').forEach(opt => {
                if (opt.value === 'en') opt.textContent = `${t('header.langIcon')} EN`;
                if (opt.value === 'it') opt.textContent = `${t('header.langIcon')} IT`;
            });
            const btnTheme = document.getElementById('btnTheme');
            if (btnTheme) {
                btnTheme.setAttribute('aria-label', currentTheme === 'light' ? t('theme.dark') : t('theme.light'));
                btnTheme.textContent = currentTheme === 'light' ? '‚óê' : '‚óë';
            }
            if (bootLoadingText) bootLoadingText.textContent = t('loading') || 'Loading data‚Ä¶';
        }

        // Jellyfin users selector
        function renderJellyfinUsers() {
            const container = document.getElementById('jellyfinUsers');
            if (!jellyfinUsers.length) {
                container.innerHTML = `<div class="muted">${t('label.noJellyfinUsers')}</div>`;
                return;
            }
            container.innerHTML = jellyfinUsers.map(u => {
                const checked = u.enabled ? 'checked' : '';
                const idLine = u.user_id ? `<div class="muted" style="font-size:12px;">${escapeHtml(u.user_id)}</div>` : '';
                return `
        <div class="card" style="align-items:center; padding:10px;">
          <div style="display:flex; flex-direction:column; gap:4px; flex:1;">
            <div class="title">${escapeHtml(u.name || '')}</div>
            ${idLine}
          </div>
          <input type="checkbox" data-user-id="${escapeHtml(u.user_id || '')}" ${checked} style="width:22px; height:22px; cursor:pointer;" />
        </div>
      `;
            }).join('');
            container.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                cb.addEventListener('change', async (e) => {
                    const uid = e.target.getAttribute('data-user-id');
                    try {
                        await fetch('/api/users/toggle', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ user_id: uid, enabled: e.target.checked })
                        });
                        await loadSummary();
                        await loadRecent();
                        showStatus(t('status.jellyfinSaved'), 'success');
                    } catch (err) {
                        e.target.checked = !e.target.checked;
                        alert(t('label.jellyfinToggleError'));
                    }
                });
            });
        }

        async function loadJellyfinUsers() {
            try {
                const r = await fetch('/api/users');
                if (!r.ok) throw new Error('users');
                const data = await r.json();
                jellyfinUsers = data.users || [];
                renderJellyfinUsers();
                setBackendStatus('', false);
            } catch (e) {
                setBackendStatus('‚ö†Ô∏è Jellyfin non raggiungibile (users).', true);
                throw e;
            }
        }

        function renderRecent() {
            const container = document.getElementById('recentList');
            if (!recentItems.length) {
                container.innerHTML = `<div class="muted">${t('label.noRecent')}</div>`;
                return;
            }
            container.innerHTML = recentItems.map(it => {
                const subtitleParts = [];
                if (it.type === 'episode') {
                    const season = it.seasonIndex ? `S${String(it.seasonIndex).padStart(2, '0')}` : '';
                    const ep = it.episodeIndex ? `E${String(it.episodeIndex).padStart(2, '0')}` : '';
                    const serie = it.seriesName || '';
                    subtitleParts.push([season, ep].filter(Boolean).join(''));
                    subtitleParts.push(serie);
                } else {
                    subtitleParts.push(it.year || '');
                }
                const dateStr = it.date ? new Date(it.date * 1000).toLocaleString() : '';
                const thumb = it.thumb ? `<img src="${it.thumb}" alt="" style="width:70px; height:100px; object-fit:cover; border-radius:8px;">` : `<span class="muted">${t('label.noPoster')}</span>`;
                return `<div class="card" style="padding:10px; gap:10px; align-items:center; width:240px;">
          ${thumb}
          <div class="meta" style="padding:0; gap:4px;">
            <div class="title">${escapeHtml(it.title || it.seriesName || '')}</div>
            <div class="muted">${escapeHtml(subtitleParts.filter(Boolean).join(' ¬∑ '))}</div>
            <div class="muted" style="font-size:12px;">${escapeHtml(t('label.recentAt', { date: dateStr }))}</div>
            <div class="muted" style="font-size:12px;">${escapeHtml(it.userName || '')}</div>
          </div>
        </div>`;
            }).join('');
        }

        async function loadRecent() {
            try {
                const r = await fetch('/api/recent');
                if (!r.ok) throw new Error('recent');
                const data = await r.json();
                recentItems = data.items || [];
                renderRecent();
                setBackendStatus('', false);
            } catch (e) {
                setBackendStatus('‚ö†Ô∏è Jellyfin non raggiungibile (recent).', true);
                throw e;
            }
        }

        function openJellyfinModal() {
            document.getElementById('jellyfinModal').style.display = 'flex';
        }

        function closeJellyfinModal() {
            document.getElementById('jellyfinModal').style.display = 'none';
        }

        function openTraktModal() {
            document.getElementById('traktModal').style.display = 'flex';
        }

        function closeTraktModal() {
            document.getElementById('traktModal').style.display = 'none';
        }

        function openBackupModal() {
            document.getElementById('backupModal').style.display = 'flex';
        }

        function closeBackupModal() {
            document.getElementById('backupModal').style.display = 'none';
        }

        async function downloadBackup() {
            try {
                const r = await fetch('/api/backup');
                if (!r.ok) throw new Error('failed');
                const blob = await r.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'trakt-multi-scrobbler-backup.zip';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showStatus(t('status.backupOk'), 'success');
            } catch (e) {
                showStatus(t('status.backupError'), 'error');
            }
        }

        async function restoreBackup(file) {
            if (!file) return;
            const form = new FormData();
            form.append('file', file);
            try {
                const r = await fetch('/api/backup/restore', {
                    method: 'POST',
                    body: form
                });
                const data = await r.json().catch(() => ({}));
                if (!r.ok || !data.ok) throw new Error(data.error || 'restore_failed');
                showStatus(t('status.restoreOk'), 'success');
                await loadSummary();
                await loadTraktAccounts();
                await loadContentItems();
            } catch (e) {
                showStatus(t('status.restoreError'), 'error');
            }
        }

        async function loadCacheStatus() {
            try {
                const r = await fetch('/api/thumbs/status');
                const data = await r.json();
                const last = data.lastRefresh ? new Date(data.lastRefresh * 1000).toLocaleString() : t('label.never');
                document.getElementById('cacheLast').textContent = t('cache.last', { date: last });
                document.getElementById('cacheFiles').textContent = t('cache.files', { count: data.files || 0 });
                const sizeMb = data.size ? (data.size / (1024 * 1024)).toFixed(1) : '0';
                document.getElementById('cacheSize').textContent = t('cache.size', { mb: sizeMb });
            } catch (e) {
                document.getElementById('cacheLast').textContent = t('cache.statusError');
                document.getElementById('cacheFiles').textContent = '‚Äî';
                document.getElementById('cacheSize').textContent = '‚Äî';
            }
        }

        async function refreshCacheThumbs() {
            const btn = document.getElementById('btnCacheRefresh');
            btn.disabled = true;
            const orig = btn.textContent;
            btn.textContent = t('cache.refreshing');
            try {
                const r = await fetch('/api/thumbs/refresh', { method: 'POST' });
                const data = await r.json().catch(() => ({}));
                if (!r.ok || !data.ok) throw new Error(data.error || 'refresh_failed');
                showStatus(t('cache.refreshed'), 'success');
                await loadCacheStatus();
            } catch (e) {
                showStatus(t('cache.refreshError'), 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = orig;
            }
        }

        // Content filters list rendering
        function renderTraktAccounts(configured) {
            const container = document.getElementById('traktAccounts');
            const notice = document.getElementById('traktNotice');
            if (!configured) {
                notice.style.display = 'block';
                notice.textContent = t('label.traktNotConfigured');
                container.innerHTML = '';
                return;
            }
            notice.style.display = 'none';
            if (!traktAccounts.length) {
                container.innerHTML = `<div class="muted">${t('label.noTraktAccounts')}</div>`;
                return;
            }
            container.innerHTML = traktAccounts.map(acc => {
                const last = acc.last_synced_at ? new Date(acc.last_synced_at * 1000).toLocaleString() : t('label.never');
                const badge = acc.enabled ? t('label.enabled') : t('label.disabled');
                const checked = acc.enabled ? 'checked' : '';
                return `
        <div class="card" style="align-items:center; padding:10px;">
          <div style="display:flex; flex-direction:column; gap:6px; flex:1;">
            <div class="title">${escapeHtml(acc.username)}</div>
            <div class="muted">${t('label.lastSynced', {date: last})}</div>
            <div class="muted">${t('label.traktStatus', {status: badge})}</div>
          </div>
          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end;">
            <button class="pill" data-view="${escapeHtml(acc.username)}">${t('button.viewAccount')}</button>
            <input type="checkbox" data-username="${escapeHtml(acc.username)}" ${checked} style="width:22px; height:22px; cursor:pointer;" />
            <button class="pill" data-delete="${escapeHtml(acc.username)}" style="background:#241014;">${t('button.delete')}</button>
          </div>
        </div>
      `;
            }).join('');

            container.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                cb.addEventListener('change', async (e) => {
                    const username = e.target.getAttribute('data-username');
                    cb.disabled = true;
                    try {
                        const resp = await fetch('/api/trakt/accounts/toggle', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ username, enabled: e.target.checked })
                        });
                        if (!resp.ok) throw new Error('save_failed');
                        showStatus(t('status.traktSaved'), 'success');
                        await loadTraktAccounts();
                        await loadContentItems();
                    } catch (err) {
                        e.target.checked = !e.target.checked;
                        showStatus(t('status.saveError'), 'error');
                    } finally {
                        cb.disabled = false;
                    }
                });
            });

            container.querySelectorAll('button[data-delete]').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const username = btn.getAttribute('data-delete');
                    try {
                        const resp = await fetch('/api/trakt/accounts/delete', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ username })
                        });
                        if (!resp.ok) throw new Error('delete_failed');
                        showStatus(t('status.traktDeleted'), 'success');
                        await loadTraktAccounts();
                        await loadContentItems();
                    } catch (err) {
                        showStatus(t('status.saveError'), 'error');
                    }
                });
            });
            container.querySelectorAll('button[data-view]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const username = btn.getAttribute('data-view');
                    if (username) {
                        window.location.href = `/trakt/${encodeURIComponent(username)}`;
                    }
                });
            });
        }

        async function loadTraktAccounts() {
            const r = await fetch('/api/trakt/accounts');
            const data = await r.json();
            traktAccounts = data.accounts || [];
            renderTraktAccounts(!!data.configured);
            // bulk select options
            const bulkSel = document.getElementById('bulkAccount');
            const prev = bulkSel.value;
            bulkSel.innerHTML = traktAccounts.map(a => `<option value="${escapeHtml(a.username)}">${escapeHtml(a.username)}</option>`).join('');
            if (prev && traktAccounts.some(a => a.username === prev)) {
                bulkSel.value = prev;
            } else if (traktAccounts.length) {
                bulkSel.value = traktAccounts[0].username;
            }
            // account filter options
            const accountSel = document.getElementById('accountFilter');
            const prevAcc = accountSel.value;
            accountSel.innerHTML = `<option value="">${escapeHtml(t('filter.accountAny'))}</option>` + traktAccounts.map(a => `<option value="${escapeHtml(a.username)}">${escapeHtml(a.username)}</option>`).join('');
            if (prevAcc && traktAccounts.some(a => a.username === prevAcc)) {
                accountSel.value = prevAcc;
            } else {
                accountSel.value = '';
                accountFilter = '';
            }
            if (accountFilter && traktAccounts.some(a => a.username === accountFilter)) {
                bulkSel.value = accountFilter;
            }
        }

        function renderContentList() {
            const q = (document.getElementById('search').value || '').toLowerCase().trim();
            const list = document.getElementById('grid');
            if (!contentItems.length) {
                list.innerHTML = `<div class="muted">${t('content.empty')}</div>`;
                return;
            }
            const filtered = (q ? contentItems.filter(i => (i.title || '').toLowerCase().includes(q)) : contentItems)
                .filter(i => {
                    if (contentFilter === 'all') return true;
                    if (contentFilter === 'movies') return i.type === 'movie';
                    if (contentFilter === 'shows') return i.type === 'show';
                    if (contentFilter === 'unassigned') {
                        const accs = i.accounts || [];
                        if (!accs.length) return false;
                        return accs.every(a => !a.ruleEnabled);
                    }
                    return true;
                })
                .filter(i => {
                    if (!accountFilter) return true;
                    const accs = i.accounts || [];
                    return accs.some(a => a.username === accountFilter);
                })
                .filter(i => {
                    if (!alphaFilter) return true;
                    const title = (i.title || '').trim();
                    if (!title) return false;
                    const first = title[0].toUpperCase();
                    if (alphaFilter === '#') {
                        return first >= '0' && first <= '9';
                    }
                    return first === alphaFilter;
                });
            list.innerHTML = filtered.map(it => {
                const accountsHtml = (it.accounts || []).map(acc => {
                    const checked = acc.ruleEnabled ? 'checked' : '';
                    return `<label style="display:flex; align-items:center; gap:6px;">
                      <input type="checkbox" data-username="${escapeHtml(acc.username)}" data-provider-key="${escapeHtml(it.providerKey || '')}" data-group-key="${escapeHtml(it.groupKey || '')}" data-type="${escapeHtml(it.type || '')}" ${checked}/>
                      <span class="muted">${escapeHtml(acc.username)}${acc.accountEnabled ? '' : ' (off)'}</span>
                    </label>`;
                }).join('');
                const poster = it.thumb ? `<img src="${it.thumb}" alt="">` : `<span class="muted">${t('label.noPoster')}</span>`;
                const subtitle = [it.type, it.year].filter(Boolean).join(' ¬∑ ');
                return `<div class="card">
                  <div class="poster">${poster}</div>
                  <div class="meta">
                    <div class="title">${escapeHtml(it.title || '')}</div>
                    <div class="sub">${escapeHtml(subtitle)}</div>
                    <div style="display:flex; gap:12px; flex-wrap:wrap;">${accountsHtml}</div>
                  </div>
                </div>`;
            }).join('');

            list.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                cb.addEventListener('change', async (e) => {
                    const username = e.target.getAttribute('data-username');
                    const pk = e.target.getAttribute('data-provider-key');
                    const gk = e.target.getAttribute('data-group-key');
                    const typ = e.target.getAttribute('data-type') || '';
                    cb.disabled = true;
                    try {
                        const resp = await fetch('/api/trakt/items/set', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ username, providerKey: pk, groupKey: gk, type: typ, enabled: e.target.checked })
                        });
                        if (!resp.ok) throw new Error('save_failed');
                        showStatus(t('status.saved'), 'success');
                    } catch (err) {
                        e.target.checked = !e.target.checked;
                        showStatus(t('status.saveError'), 'error');
                    } finally {
                        cb.disabled = false;
                    }
                });
            });
        }

        async function loadContentItems() {
            try {
                const r = await fetch('/api/trakt/items');
                if (!r.ok) throw new Error('items');
                const data = await r.json();
                contentItems = data.items || [];
                renderOrphans();
                renderContentList();
                setBackendStatus('', false);
            } catch (e) {
                setBackendStatus('‚ö†Ô∏è Jellyfin/Trakt non raggiungibili (items).', true);
                throw e;
            }
        }

        function renderOrphans() {
            const sec = document.getElementById('orphansSection');
            const list = document.getElementById('orphansList');
            const countEl = document.getElementById('orphansCount');
            const orphans = contentItems.filter(it => {
                const accs = it.accounts || [];
                if (!accs.length) return false;
                return accs.every(a => !a.ruleEnabled);
            });
            if (!orphans.length) {
                sec.style.display = 'none';
                list.innerHTML = '';
                countEl.textContent = '0';
                return;
            }
            sec.style.display = 'block';
            countEl.textContent = String(orphans.length);
            list.innerHTML = orphans.map(it => {
                const poster = it.thumb ? `<img src="${it.thumb}" alt="" style="width:70px; height:100px; object-fit:cover; border-radius:8px;">` : '';
                const subtitle = [it.type, it.year].filter(Boolean).join(' ¬∑ ');
                return `<div class="card" style="padding:8px; gap:8px; align-items:center; width:230px;">
                  ${poster || ''}
                  <div class="meta" style="padding:0; gap:4px;">
                    <div class="title">${escapeHtml(it.title || '')}</div>
                    <div class="muted">${escapeHtml(subtitle)}</div>
                  </div>
                </div>`;
            }).join('');
        }

        async function bulkApply(enable) {
            const account = document.getElementById('bulkAccount').value;
            if (!account) {
                alert(t('bulk.noAccount'));
                return;
            }
            const q = (document.getElementById('search').value || '').toLowerCase().trim();
            const targets = (q ? contentItems.filter(i => (i.title || '').toLowerCase().includes(q)) : contentItems)
                .filter(i => contentFilter === 'all' ? true : (i.type === (contentFilter === 'movies' ? 'movie' : 'show')))
                .filter(i => {
                    if (!alphaFilter) return true;
                    const title = (i.title || '').trim();
                    if (!title) return false;
                    const first = title[0].toUpperCase();
                    if (alphaFilter === '#') {
                        return first >= '0' && first <= '9';
                    }
                    return first === alphaFilter;
                })
                .filter(i => {
                    if (!accountFilter) return true;
                    const accs = i.accounts || [];
                    return accs.some(a => a.username === account);
                });
            if (!targets.length) return;
            // Optimistic update locally
            targets.forEach(it => {
                it.accounts = (it.accounts || []).map(acc => acc.username === account ? { ...acc, ruleEnabled: enable } : acc);
            });
            renderOrphans();
            renderContentList();
            try {
                await Promise.all(targets.map(it => fetch('/api/trakt/items/set', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: account,
                        providerKey: it.providerKey || "",
                        groupKey: it.groupKey || "",
                        type: it.type || "",
                        enabled: enable
                    })
                })));
                showStatus(enable ? t('status.bulkAssigned') : t('status.bulkCleared'), 'success');
            } catch (e) {
                showStatus(t('status.saveError'), 'error');
            } finally {
                await loadContentItems();
            }
        }

        function openDeviceModal() {
            document.getElementById('deviceModal').style.display = 'flex';
        }

        function closeDeviceModal() {
            document.getElementById('deviceModal').style.display = 'none';
            document.getElementById('deviceStatus').textContent = '';
            document.getElementById('deviceCode').textContent = '‚Äî';
            document.getElementById('deviceUrl').href = '#';
            currentDeviceCode = '';
            lastPollError = false;
            if (devicePollTimer) {
                clearInterval(devicePollTimer);
                devicePollTimer = null;
            }
        }

        async function startDeviceFlow() {
            const btn = document.getElementById('btnAddTrakt');
            btn.disabled = true;
            try {
                const r = await fetch('/api/trakt/device/start', { method: 'POST' });
                const data = await r.json();
                if (!data.ok) throw new Error(data.error || 'failed');
                currentDeviceCode = data.device_code;
                deviceExpiresAt = Date.now() + (data.expires_in || 600) * 1000;
                devicePollIntervalSec = Math.max(data.interval || 5, 10); // wait a bit longer than spec to avoid 400 while user authorizes
                lastPollError = false;
                document.getElementById('deviceCode').textContent = data.user_code || '‚Äî';
                document.getElementById('deviceUrl').href = data.verification_url || '#';
                document.getElementById('deviceStatus').textContent = t('modal.waiting', { seconds: devicePollIntervalSec });
                openDeviceModal();
                devicePollTimer = setInterval(pollDeviceFlow, devicePollIntervalSec * 1000);
            } catch (e) {
                alert(t('modal.startError'));
            } finally {
                btn.disabled = false;
            }
        }

        async function pollDeviceFlow() {
            if (!currentDeviceCode) return;
            if (Date.now() > deviceExpiresAt) {
                document.getElementById('deviceStatus').textContent = t('modal.expired');
                clearInterval(devicePollTimer);
                devicePollTimer = null;
                return;
            }
            try {
                const r = await fetch('/api/trakt/device/poll', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ device_code: currentDeviceCode })
                });
                const data = await r.json();
                if (data.status === 'pending') {
                    document.getElementById('deviceStatus').textContent = t('modal.waiting', { seconds: devicePollIntervalSec });
                    lastPollError = false;
                    return;
                }
                if (data.status === 'approved') {
                    document.getElementById('deviceStatus').textContent = t('modal.approved', { user: data.username || '' });
                    clearInterval(devicePollTimer);
                    devicePollTimer = null;
                    await loadTraktAccounts();
                    await loadContentItems();
                    setTimeout(closeDeviceModal, 1500);
                    return;
                }
                if (data.status === 'rejected') {
                    document.getElementById('deviceStatus').textContent = t('modal.expired');
                    clearInterval(devicePollTimer);
                    devicePollTimer = null;
                    return;
                }
                // Unknown/error: keep polling but surface message.
                document.getElementById('deviceStatus').textContent = t('modal.error');
                lastPollError = true;
            } catch (e) {
                document.getElementById('deviceStatus').textContent = t('modal.error');
                lastPollError = true;
            }
        }

        async function triggerSync() {
            const btn = document.getElementById('btnSync');
            btn.disabled = true;
            btn.textContent = t('button.syncing');
            try {
                const r = await fetch('/api/trakt/sync', { method: 'POST' });
                const data = await r.json();
                const results = data.results || {};
                const parts = Object.entries(results).map(([user, res]) => {
                    if (res.skipped) return `${user}: ${t('status.syncSkipped', { reason: res.reason || '' })}`;
                    if (res.ok) {
                        const m = res.sent?.movies || 0;
                        const e = res.sent?.episodes || 0;
                        const miss = res.skipped_missing_ids || 0;
                        const dis = res.skipped_disallowed || 0;
                        return `${user}: ${m}m/${e}e, ${miss} missing ids, ${dis} unassigned`;
                    }
                    return `${user}: ${t('status.syncError')}`;
                });
                showStatus(parts.join(' | ') || t('status.syncDone'), 'success');
            } catch (e) {
                showStatus(t('status.syncError'), 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = t('button.sync');
                await loadTraktAccounts();
            }
        }

        async function loadSummary() {
            try {
                const r = await fetch('/api/summary');
                if (!r.ok) throw new Error('summary');
                const s = await r.json();
                const date = s.lastRefresh ? new Date(s.lastRefresh * 1000).toLocaleString() : '‚Äî';
                const trakt = s.traktConfigured ? t('label.traktOn') : t('label.traktOff');
                const movies = s.movies ?? '0';
                const shows = s.shows ?? '0';
                document.getElementById('summary').textContent = `${t('label.libraryCounts', { movies, shows })} ¬∑ ${t('header.summaryIcon')} ${t('summary.updated', { date })}`;
                const selectedUsers = s.selectedUsers ?? s.users ?? 0;
                const totalUsers = s.totalUsers ?? s.users ?? 0;
                document.getElementById('btnJellyfinModal').textContent = `${t('button.jellyfinModal')} ${t('label.usersSuffix')} ¬∑ ${selectedUsers}/${totalUsers}`;
                const traktAccounts = s.traktAccounts ?? [];
                const traktTotal = traktAccounts.length || (s.traktTotal ?? 0) || 0;
                const traktEnabled = traktAccounts.filter(a => a && a.enabled).length;
                document.getElementById('btnTraktModal').textContent = `${t('button.traktModal')} ${t('label.usersSuffix')} ¬∑ ${traktEnabled}/${traktTotal} ¬∑ ${trakt}`;
                setBackendStatus('', false);
            } catch (e) {
                setBackendStatus('‚ö†Ô∏è Jellyfin non raggiungibile (summary).', true);
                throw e;
            }
        }

        document.getElementById('btnRefresh').addEventListener('click', async () => {
            const btn = document.getElementById('btnRefresh');
            btn.disabled = true;
            try {
                await fetch('/api/refresh', { method: 'POST' });
                await loadSummary();
                await loadJellyfinUsers();
                await loadRecent();
                await loadContentItems();
                showStatus(t('status.refreshed'), 'success');
            } catch (e) {
                showStatus(t('status.refreshError'), 'error');
            } finally {
                btn.disabled = false;
            }
        });

        document.getElementById('btnSync').addEventListener('click', triggerSync);
        document.getElementById('btnReloadTrakt').addEventListener('click', async () => {
            await loadTraktAccounts();
            showStatus(t('status.traktReloaded'), 'success');
        });
        document.getElementById('btnAddTrakt').addEventListener('click', startDeviceFlow);
        document.getElementById('btnPollNow').addEventListener('click', pollDeviceFlow);
        document.getElementById('btnSelectAll').addEventListener('click', () => bulkApply(true));
        document.getElementById('btnDeselectAll').addEventListener('click', () => bulkApply(false));
        document.getElementById('search').addEventListener('input', renderContentList);
        document.getElementById('accountFilter').addEventListener('change', (e) => {
            accountFilter = e.target.value || '';
            if (accountFilter) {
                const bulkSel = document.getElementById('bulkAccount');
                if ([...bulkSel.options].some(o => o.value === accountFilter)) {
                    bulkSel.value = accountFilter;
                }
            }
            renderContentList();
        });
        document.getElementById('btnJellyfinModal').addEventListener('click', () => { loadJellyfinUsers(); openJellyfinModal(); });
        document.getElementById('btnTraktModal').addEventListener('click', () => { loadTraktAccounts(); openTraktModal(); });
        document.getElementById('btnTheme').addEventListener('click', () => {
            applyTheme(currentTheme === 'light' ? 'dark' : 'light');
        });
        document.getElementById('btnBackup').addEventListener('click', openBackupModal);
        document.getElementById('btnBackupDownload').addEventListener('click', downloadBackup);
        document.getElementById('btnBackupRestore').addEventListener('click', () => {
            document.getElementById('backupFile').click();
        });
        document.getElementById('btnCacheRefresh').addEventListener('click', refreshCacheThumbs);
        document.getElementById('backupFile').addEventListener('change', async (e) => {
            const file = e.target.files && e.target.files[0];
            if (file) {
                await restoreBackup(file);
                e.target.value = '';
            }
        });
        document.getElementById('btnCloseJellyfin').addEventListener('click', closeJellyfinModal);
        document.getElementById('btnCloseTrakt').addEventListener('click', closeTraktModal);
        document.getElementById('btnCloseBackup').addEventListener('click', closeBackupModal);
        document.getElementById('langSelect').addEventListener('change', async (e) => {
            await loadLang(e.target.value);
            await loadSummary();
            await loadJellyfinUsers();
            await loadRecent();
            await loadTraktAccounts();
            await loadContentItems();
            document.getElementById('btnBackup').title = t('button.backup');
            document.getElementById('btnBackup').textContent = `üíæ ${t('button.backup')}`;
            document.getElementById('btnBackupDownload').title = t('button.backup');
            document.getElementById('btnBackupRestore').title = t('button.restore');
            document.getElementById('backupTitle').textContent = t('backup.title');
            document.getElementById('backupHelper').textContent = t('backup.helper');
            document.getElementById('backupHint').textContent = t('backup.hint');
            document.getElementById('backupDownloadLabel').textContent = t('button.backup');
            document.getElementById('backupRestoreLabel').textContent = t('button.restore');
            document.getElementById('cacheTitle').textContent = t('cache.title');
            document.getElementById('cacheHelper').textContent = t('cache.helper');
            document.getElementById('cacheRefreshLabel').textContent = t('cache.refresh');
            await loadCacheStatus();
        });
        document.getElementById('btnCloseDevice').addEventListener('click', closeDeviceModal);
        document.getElementById('btnCancelDevice').addEventListener('click', closeDeviceModal);
        document.getElementById('deviceModal').addEventListener('click', (e) => { if (e.target === document.getElementById('deviceModal')) closeDeviceModal(); });
        document.getElementById('jellyfinModal').addEventListener('click', (e) => { if (e.target === document.getElementById('jellyfinModal')) closeJellyfinModal(); });
        document.getElementById('traktModal').addEventListener('click', (e) => { if (e.target === document.getElementById('traktModal')) closeTraktModal(); });
        document.getElementById('backupModal').addEventListener('click', (e) => { if (e.target === document.getElementById('backupModal')) closeBackupModal(); });
        document.getElementById('filterAll').addEventListener('click', () => { contentFilter = 'all'; renderContentList(); });
        document.getElementById('filterMovies').addEventListener('click', () => { contentFilter = 'movies'; renderContentList(); });
        document.getElementById('filterShows').addEventListener('click', () => { contentFilter = 'shows'; renderContentList(); });
        document.getElementById('filterUnassigned').addEventListener('click', () => { contentFilter = 'unassigned'; renderContentList(); });

        (async () => {
            const storedLang = localStorage.getItem('lang') || 'en';
            initTheme();
            try {
                await loadLang(storedLang);
                document.getElementById('btnBackup').title = t('button.backup');
                document.getElementById('btnBackup').textContent = `üíæ ${t('button.backup')}`;
                document.getElementById('btnBackupDownload').title = t('button.backup');
                document.getElementById('btnBackupRestore').title = t('button.restore');
                document.getElementById('backupTitle').textContent = t('backup.title');
                document.getElementById('backupHelper').textContent = t('backup.helper');
                document.getElementById('backupHint').textContent = t('backup.hint');
                document.getElementById('backupDownloadLabel').textContent = t('button.backup');
                document.getElementById('backupRestoreLabel').textContent = t('button.restore');
                document.getElementById('cacheTitle').textContent = t('cache.title');
                document.getElementById('cacheHelper').textContent = t('cache.helper');
                document.getElementById('cacheRefreshLabel').textContent = t('cache.refresh');
                await loadSummary();
                await loadJellyfinUsers();
                await loadRecent();
                await loadTraktAccounts();
                await loadContentItems();
                await loadCacheStatus();
            } catch (e) {
                showStatus('Initial load failed, retry with Refresh.', 'error');
            } finally {
                if (bootLoading) bootLoading.style.display = 'none';
            }
        })();
    </script>
</body>

</html>
